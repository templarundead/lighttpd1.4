          name: Windows Cygwin Build with Artifacts

          on:
            push:
              branches: [main, master]
              tags: ['lighttpd-*']
            workflow_dispatch:

          jobs:
            windows-cygwin:
              runs-on: windows-latest
              env:
                CYGWIN: winsymlinks:native
              
              steps:
                - run: git config --global core.autocrlf input
                - uses: actions/checkout@v6
                
                - name: Set up env and create cache dir
                  id: env
                  shell: pwsh
                  run: |
                    Add-Content -Path $env:GITHUB_ENV -Value "CACHE_KEY=$(Get-Date -UFormat "%Y-%m")" -Encoding utf8NoBOM
                    New-Item -ItemType Directory -Force -Path D:\cygwin
                
                - name: Cache Cygwin installation
                  uses: actions/cache@v4
                  with:
                    path: /cygwin
                    key: cygwin-${{ runner.os }}-${{ env.CACHE_KEY }}
                    restore-keys: |
                      cygwin-${{ runner.os }}-${{ env.CACHE_KEY }}
                
                - uses: cygwin/cygwin-install-action@master
                  with:
                    install-dir: D:\cygwin
                    allow-test-packages: true
                    packages: >
                      autoconf automake libtool m4 make
                      cmake meson ninja scons
                      gcc-g++ git pkgconf perl zip
                      libpcre2-devel
                      libnettle-devel
                      libgnutls-devel mbedtls-devel libnss-devel libssl-devel
                      libbrotli-devel libdeflate-devel zlib-devel libzstd-devel
                      libsasl2-devel libkrb5-devel libdbi-devel openldap-devel
                      libmariadb-devel libpq-devel
                      libmaxminddb-devel libunwind-devel lua-devel lua5.1-devel
                      libxml2-devel libsqlite3-devel
                      libintl-devel
                
                - name: Compile and Test
                  id: build
                  shell: D:\cygwin\bin\bash.exe --noprofile --norc -o igncr -eo pipefail '{0}'
                  run: |
                    set -e
                    export PATH=/usr/bin:$(cygpath ${SYSTEMROOT})/system32
                    export NO_PAM=1 NO_UNWIND=1 NO_WOLFSSL=1
                    export SHELL=/bin/dash
                    
                    echo "Starting build process..."
                    cd "${{github.workspace}}" && /bin/dash scripts/ci-build.sh autobuild
                    
                    echo "Looking for compiled binaries..."
                    # Ищем везде, но проверяем конкретные места
                    find . -name "lighttpd.exe"
                    
                    # Оптимизированная проверка: ищем в build ИЛИ в src (где он реально лежит)
                    if [ -f "./src/lighttpd.exe" ] || [ -f "./src/lighttpd" ] || [ -f "./build/lighttpd.exe" ]; then
                      echo "Build completed successfully!"
                    else
                      echo "ERROR: lighttpd binary not found!"
                      exit 1
                    fi
                
                - name: Collect binaries and create package
                  shell: D:\cygwin\bin\bash.exe --noprofile --norc -o igncr -eo pipefail '{0}'
                  run: |
                    set -e
                    # Используем рабочую директорию вместо /tmp/
                    ARTIFACT_DIR="${{ github.workspace }}/package_dist"
                    mkdir -p "$ARTIFACT_DIR"
                    
                    # [ ... твой код копирования файлов в $ARTIFACT_DIR ... ]
                    # Сделай копирование бинарников из src (как обсуждали ранее)
                    find ./src -type f \( -name "lighttpd.exe" -o -name "*.dll" \) -exec cp {} "$ARTIFACT_DIR/" \;
                    find ./src/.libs -name "*.dll" -exec cp {} "$ARTIFACT_DIR/" \; 2>/dev/null || true
                    
                    # Создаем архив прямо в корне воркспейса
                    echo "Creating archive..."
                    ZIP_NAME="lighttpd-cygwin-windows.zip"
                    cd "$ARTIFACT_DIR"
                    zip -r "${{ github.workspace }}/$ZIP_NAME" .
                    
                    # Передаем ПРАВИЛЬНЫЙ Windows-путь для шага Upload
                    # cygpath -w конвертирует /home/runner/... в D:\a\...
                    WIN_PATH=$(cygpath -w "${{ github.workspace }}/$ZIP_NAME")
                    echo "ARCHIVE_PATH=$WIN_PATH" >> $GITHUB_ENV
                    
                    echo "Archive contents:"
                    unzip -l "${{ github.workspace }}/$ZIP_NAME" | head -20

                - name: Upload Artifacts
                  uses: actions/upload-artifact@v4
                  with:
                    name: lighttpd-cygwin-windows
                    path: ${{ env.ARCHIVE_PATH }}
                    retention-days: 30
                    if-no-files-found: error

                - name: Upload Individual Binaries (backup)
                  if: always()
                  shell: D:\cygwin\bin\bash.exe --noprofile --norc -o igncr -eo pipefail '{0}'
                  run: |
                    echo "Uploading individual binary files as backup..."
                    cd "${{github.workspace}}"
                   
                    # Ищем и загружаем основные бинарники
                    find . -type f \( -name "lighttpd*" -o -name "*.exe" \) ! -path "./.git/*" -exec ls -la {} \; | head -10 || true
                   
                    # Альтернативно, можно сохранять логи сборки
                    if [ -f "build.log" ] || [ -f "config.log" ]; then
                     echo "Found build logs, uploading..."
                    fi
                  continue-on-error: true