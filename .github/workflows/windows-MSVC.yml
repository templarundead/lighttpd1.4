name: Windows MSVC Native Build

on:
  push:
    branches: [main, master]
    tags: ['MSVC-*']
  workflow_dispatch:

jobs:
  build-msvc:
    runs-on: windows-latest
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies (vcpkg)
        # Принудительно интегрируем vcpkg в систему и ставим библиотеки
        run: |
          vcpkg integrate install
          vcpkg install pcre2:x64-windows zlib:x64-windows libdeflate:x64-windows

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DWITH_PCRE2=ON `
            -DWITH_ZLIB=ON `
            -DWITH_LUA=OFF

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path ./dist
          
          # Копируем бинарник
          Copy-Item ./build/src/Release/lighttpd.exe ./dist/ -ErrorAction SilentlyContinue
          # Если CMake положил его в корень build
          if (!(Test-Path ./dist/lighttpd.exe)) { 
            Copy-Item ./build/Release/lighttpd.exe ./dist/ 
          }
          
          # ВАЖНО: Копируем необходимые DLL из vcpkg
          # vcpkg обычно кладет их в папку установки
          $VCPKG_BIN = "C:/vcpkg/installed/x64-windows/bin"
          Get-ChildItem -Path $VCPKG_BIN -Filter "*.dll" | Copy-Item -Destination ./dist/
          
          # Копируем стандартные конфиги для удобства
          if (Test-Path ./doc/config) {
              Copy-Item -Recurse ./doc/config ./dist/
          }

      - name: Upload Native Build
        uses: actions/upload-artifact@v4
        with:
          name: lighttpd-msvc-native
          path: ./dist/
